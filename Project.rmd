---
title: 'STAT 151A Project'
subtitle: 'Predicting Housing Resale Prices in Singapore'
date: "April 10th 2024"
author: "Michelle Vuong, Celina Mac, Lewis Chong"
output:
  pdf_document: default
  html_document: default
---

## Introduction

## Research Objectives

Our research objective is to gain understanding of the effect COVID-19 had on the Singaporean housing market. We aim to create an efficient and concise model that gives us an answer to the question: how do the resale prices differ between the years of 2017-2019 and 2020-2022? In addition, we will analyze the original set of housing metric indicators provided from the data set given to us from Kaggle and determine if we can refine the number of indicators to a minimum. Making use of statistical analysis techniques such as Ridge and Lasso regularization, we aim to extract the most important predictors that can still effectively provide us an understanding of the resale prices of Singaporean homes.

## Data Collection

Our data collection process began with an open web research on the housing markets of Singapore. We landed on Kaggle, an open source hub of public data sets uploaded by public users, which can be used for data exploration, building predictive models, and general practice with real-world data. Specifically, our data from Kaggle was transcribed by a user from the Singapore Government Agency Website that studied Resale flat prices based on registration date from Jan-2017 onwards. Data was collected by the Housing and Development Board, commonly referred to as "HDB". It is a statutory board of the Ministry of National Development in Singapore and it seeks to provide support in homeownership and ease in rental processes for residents. Simultaneously as the HDB are providing aid, they are collecting data on what home are being bought, built, and sold for. As this government established board provides public housing for more than 80% of Singapore's population, this project will make the assumption that all data was collected as a random sample of Singapore's population and data quality is up to par with research standards.

## EDA + Data Preprocessing

We will begin with Exploratory Data Analysis to understand the data that we are working with.

```{r libraries, include=FALSE}

library(MASS)
library(glmnet)
if (!requireNamespace("caret", quietly = TRUE)) {
  # If not installed, install the package
  install.packages("caret")
}

library(caret)
library(tidyverse)

housing <- read.csv("Resale_Price_2017_2022.csv")
```

### Data Inspection

```{r}

cat("Dimension of data: ", dim(housing), "\n")

#NA values in cols
na_counts <- colSums(is.na(housing))

# 
any_na <- any(na_counts > 0)

cat("Datasets contains NA values : ",any_na)
```

There are no null values in the dataset, so it is clean.

```{r}
head(housing)
summary(housing)
```

Upon our first inspection of the data, we will be using the `resale_price` as the response variable, and the columns `flat_type,floor_area_sqm,remaining_lease,town` to serve as the predictors.
```{r}
housing <- housing %>% dplyr::select(month,town,flat_type,floor_area_sqm,
                              remaining_lease,resale_price)
```


### 1. One hot encoding for Flat Type

From the above summary, we see that the `flat_type` is categorical variable. Thus,we will be apply one hot encoding on it for the model to regress. 

```{r}
housing <- housing %>%
  mutate(
    is_2_room = ifelse(flat_type == "2 ROOM", 1, 0),
    is_3_room = ifelse(flat_type == "3 ROOM", 1, 0),
    is_4_room = ifelse(flat_type == "4 ROOM", 1, 0),
    is_5_room = ifelse(flat_type == "5 ROOM", 1, 0),
    is_executive = ifelse(flat_type == "EXECUTIVE", 1, 0),
    is_1_room = ifelse(flat_type == "1 ROOM", 1, 0),
    is_multi_generation = ifelse(flat_type == "MULTI-GENERATION", 1, 0)
  ) %>% 
  dplyr::select(!flat_type)


```


Also, we noted that for `town`, there is too many distinct values: 
```{r}
cat("Distinct values for `town` :",length(unique(housing$town)))
```

Thus, we will categorize the different towns of Singapore into NSEW regions, and further apply one-hot encoding as done above. 

```{r}

# Function to categorize towns into NSEW regions
categorize_town <- function(town) {
  north <- c("ANG MO KIO", "SEMBAWANG", "SENGKANG", "WOODLANDS", "YISHUN","BISHAN")
  south <- c("BUKIT MERAH", "BUKIT TIMAH", "CENTRAL AREA", "QUEENSTOWN")
  east <- c("BEDOK", "MARINE PARADE", "PASIR RIS", "TAMPINES")
  west <- c("BUKIT BATOK", "BUKIT PANJANG", "CHOA CHU KANG", "CLEMENTI", "JURONG EAST", "JURONG WEST", "KALLANG/WHAMPOA", "PUNGGOL", "SENGKANG", "TOA PAYOH", "SERANGOON", "GEYLANG", "HOUGANG")
  
  if (town %in% north) {
    return("North")
  } else if (town %in% south) {
    return("South")
  } else if (town %in% east) {
    return("East")
  } else if (town %in% west) {
    return("West")
  } else {
    return("Other")
  }
}

# Add a new column for NSEW region
housing <- housing %>%
  rowwise() %>%
  mutate(region = categorize_town(toupper(town))) %>% 
  mutate(
    is_north = ifelse(region == "North", 1, 0),
    is_south = ifelse(region == "South", 1, 0),
    is_west = ifelse(region == "West", 1, 0),
    is_east = ifelse(region == "East", 1, 0)
  ) %>% 
  dplyr::select(!region)

```


Note that for one-hot encoding on the columns `region` and `flat_type` , we can just drop one of the columns as it can be identified by the rest of the columns, i.e `(is_north,is_south,is_west) = (0,0,0)`corresponds to the house being in the East Region.

```{r}
housing <- housing %>% 
        dplyr::select(!c(is_east,is_multi_generation,town))

##
```

###3. Data Manipulation 
We will be converting the `remaining_lease` column that contains how long the lease is to be of unit months instead of the current year+month.

```{r}

##Function to convert from years+ months to months
extract_months <- function(duration_str) {
    # Split into components
    components <- strsplit(duration_str, " ", perl = TRUE)[[1]]
    
    # Extract years and months (if available)
    years <- as.numeric(components[1])
    months <- ifelse(length(components) >= 3, as.numeric(components[length(components)-1]), 0)
    
    # Return total months
    return(years * 12 + months)
}

housing <- housing %>% 
            rowwise() %>%
            mutate(remaining_lease_mth = extract_months(remaining_lease)) %>% 
            dplyr::select(!remaining_lease)




```
###4. Standardizing Predictor Columns
```{r}
#Standardizing predictor columns
X <- housing %>% dplyr::select(floor_area_sqm,remaining_lease_mth) %>%
      scale() %>% as.data.frame()
colnames(X) <- c("floor_area_sqm_std","remaining_lease_std")

housing <- cbind(housing,X) %>% 
  dplyr::select(!c(remaining_lease_mth,floor_area_sqm))
```


```{r}
corr_mat<- cor(housing[sapply(housing, is.numeric)])
corrplot(corr_mat, method = "color", type = "upper", order ="hclust", 
         tl.col = "black", tl.srt = 45)
```

### 1. Log transform

```{r}


id <- sample(nrow(housing),7000)
sample_housing <- housing[id,]

## histogram
ggplot(sample_housing) + 
  geom_point(aes(x=floor_area_sqm,y=resale_price),size=0.5,position="identity") + 
  theme_minimal()
ggplot(sample_housing) + 
  geom_point(aes(x=floor_area_sqm,y=log(resale_price)),size=0.5,position="identity") + 
  theme_minimal()


```

We do a sample of 7000 on the original dataset, to argue that the increase of a small amount of floor area(sqm) doesn't result it a linear amount of resale price being added, but instead some non-linear increase in the price. This is equivalent to adding to a log of the resale prices. So we conclude that it results in better prediction if we do a regression on the log(resale price).


## Model Training and Evaluation

In order to evaluate the most statistically significant housing metrics and reduce the number of predictors we have, we will use regularization. Beginning with Ridge Regularization:

```{r}
X <- housing %>% dplyr::select(floor_area_sqm,remaining_lease_mth,
                          is_2_room,is_3_room,is_4_room,is_5_room,is_executive
                          ,is_1_room
                          #,is_multi_generation 
                          ,is_north,is_south,is_west
                          # ,is_east
                          ,resale_price) %>% 
                as.data.frame %>%  
                slice_sample(n=10000)

# ggplot(housing) + 
#   geom_boxplot(aes(x=resale_price))
# scale_cols <- c("floor_area_sqm","remaining_lease_mth")
# 
# X[,scale_cols] <- scale(X[, scale_cols])
# 
# 
# ans <- lm(log(resale_price) ~ ., data=X)





```

Beta values very big, so we do regularization

```{r}
# # Create an X matrix that represents the data frame above, but in linear perspective

# Perform Ridge regression
# ridge_model <- glmnet(X[,-ncol(X)], X[,ncol(X)], alpha = 0)
# #predictions <- predict.glm(ridge_model, newdata = X[,-ncol(X)])  # Adjust s (lambda) as needed
# 
# # Select the index with best lambda value.
# min_lambda <- ridge_model$lambda %>% 
#                 as.vector %>% 
#                     which.min
# best_lambda <- ridge_model$lambda[min_lambda]
# best_lambda
# 
# ridge_best <-  glmnet(X, y, alpha = 0,s=best_lambda)
```

## Subsetting our dataset

We will filter all dates before April 2020 as that was when the Singaporean government began enforcing preventive measures for the pandemic.

```{r}
pre_covid <- housing %>% 
  filter(month < "2020-04")

covid <- housing %>% 
  filter(month >= "2020-04")
```

## Limitations and Future Work
